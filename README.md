#Playing with IoT Watson platform using Gobot on Bluemix
Demo consist of two parts:
- "sensor" which collects various information about Macbook laptop - CPU temperature, fans speed and laptop position(using [SMS](https://en.wikipedia.org/wiki/Sudden_Motion_Sensor))
- Web app which visualise data from sensor and allow to set fans speed and display brightness 

#Prerequisites
- a Bluemix account
- `cf`
 

##Internet of Things Platform in your app: main steps

1. Clone repository
2. Create a Go web application from the Bluemix dashboard
3. Create the Internet of Things Platform service ![image](https://www.dropbox.com/s/8j33eikxhjh7cy5/Screenshot%202016-03-25%2018.22.33.png?dl=1)
4. Click on Internet of Things Platform service the Bluemix dashboard
5. Click on Launch dashboard ![image](https://www.dropbox.com/s/sni73nsyale9kk5/Screenshot%202016-03-25%2018.29.33.png?dl=1)
6. Create a new device in IoT Platform dashboard![image](https://www.dropbox.com/s/blamnxy48784rri/device-creation.gif?dl=1)
7. Go to `sensor` directory, run `go build` then run `sudo ./sensor -id "id you provide on device creation" -org "Organization ID" -api_token "Authentication token"` (Organisation ID and Authentication Token will be shown after your create a device.)
8. Go to repository directory and run `cf push "application name from step 2"`
9. Open application in browser, provide device id
10. Have fun!

##Some implementation details
###Creating IoT "device"
####Connecting device to IoT platform

Every registered organization has a unique endpoint which must be used when connecting MQTT clients for devices in that organization.

`org_id.messaging.internetofthings.ibmcloud.com`

You can find your org_id by going to IoT Platform Dashboard

![image](https://www.dropbox.com/s/b6gvtnl8u0dew8v/Screenshot%202016-03-28%2009.44.45.png?dl=1)

A Device must authenticate using a client ID in the following format:

`d:org_id:device_type:device_id`

- **d** idenfities your client as a device
- **org_id** is your unique organization ID
- **type_id** device type you specified while creating device in dashboar
- **device_id** ID you specified while creating device in dashboard

IoT Watson Platform currently only supports token-based authentication for devices, so there is only one valid username for devices - `use-token-auth`, use authentication token generated by platform on device creation as password.

So connectiong your Gobot sensor to IoT platform will look somehthing like:

```go
mqttAdaptor := mqtt.NewMqttAdaptorWithAuth("sensor",
	fmt.Sprintf("tcp://%s.messaging.internetofthings.ibmcloud.com:1883", *org),
	fmt.Sprintf("d:%s:gobot-sensor:%s", *org, *deviceId), username, *apiToken)
```

####Publishing device events
Devices can only publish to the event topic of the form `iot-2/evt/event_id/fmt/format_string`

- **event_id** is the ID of the event, for example “status”. The event ID can be any string permitted by MQTT. Subscriber applications must use this string in their subscription topic to receive the events published on this topic if wildcards are not used.
- **format_string** is the format of the event payload(e.g “json”). The format can be any string permitted by MQTT. Subscriber applications must use this string in their subscription topic to receive events published on this topic if wildcards are not used.

```go
gobot.Every(1*time.Second, func() {
	data, err := json.Marshal(GatherSensorInfo())
	if err == nil {
		mqttAdaptor.Publish("iot-2/evt/status/fmt/json", data)
	}
})
```

####Subscribing to commands

To receive command your device have to subscribe to command topics of the form `iot-2/cmd/command_id/fmt/format_string`.


- *command_id* is the ID of the command, for example “update”. The command ID can be any string permitted by MQTT. A device must use this string in its subscription topic in order to receive commands published on this topic if wildcards are not used.
- *format_string* is the format of the command payload, for example “json”. The format can be any string permitted by MQTT. A device must use this string in its subscription topic in order to receive commands published on this topic if wildcards are not used.

```go
mqttAdaptor.On("iot-2/cmd/set_speed/fmt/json", func(data []byte) {
	var cmd SetSpeedCmd

	if err := json.Unmarshal(data, &cmd); err == nil {
		C.SMCSetFanSpeed(C.int(cmd.Fan), C.int(cmd.Speed))
	} else {
		log.Printf("Error: %s", err)
	}
})
mqttAdaptor.On("iot-2/cmd/inc_brightness/fmt/json", func(data []byte) {
	C.IncreaseBrightness()
})
mqttAdaptor.On("iot-2/cmd/dec_brightness/fmt/json", func(data []byte) {
	C.DecreaseBrightness()
})
```

###Creating application
####Connecting application to IoT platform
An application has to use same organisation endpoint as a device. 

An application must authenticate using a client ID in the following format:

`a:org_id:app_id`

- `a` indicates the client is an application
- `org_id` is your unique organization ID
- `app_id` is a user-defined unique string identifier for this client

You don't need to register application before it connect so `app_id` can be any string following this rules:

- Contains only alpha-numeric characters (a-z, A-Z, 0-9) and the special characters: dash (-), underscore (_), dot (.)
- Maximum length of 36 characters

Applications require an API Key to connect into an organization. When an API Key is registered a token will be generated that must be used with that API key.

The API key will look something like this: `a-org_id-b2roh3bptq`

The token will look something like this: `p3C76R-54EPKmeKCPA`

![image](https://www.dropbox.com/s/f8hnsjez7ydpy2c/Screenshot%202016-03-28%2010.45.52.png?dl=1)
*Reading service credentials on the Bluemix website*

```go
if appEnv, err := cfenv.Current(); err != nil {
	org = "quickstart"
	port = ":8080"
} else {
	port = fmt.Sprintf(":%d", appEnv.Port)
	if iotfService, err := appEnv.Services.WithLabel("iotf-service"); err == nil {
		org = fmt.Sprintf("%s", iotfService[0].Credentials["org"])
		apiKey = fmt.Sprintf("%s", iotfService[0].Credentials["apiKey"])
		apiToken = fmt.Sprintf("%s", iotfService[0].Credentials["apiToken"].(string))
	}
}
...
mqttAdaptor := mqtt.NewMqttAdaptorWithAuth("server",
	fmt.Sprintf("tcp://%s.messaging.internetofthings.ibmcloud.com:1883", org),
	fmt.Sprintf("a:%s:%s", org, uuid.Formatter(u, uuid.CleanHyphen)),
	apiKey,
	apiToken)
```

####Subscribing to device events
Subscribe to topic `iot-2/type/device_type/id/device_id/evt/event_id/fmt/format_string`

The MQTT “any” wildcard character (+) may be used for any of the following components if you want to subscribe to more than one type of event, or events from more than a single device.

- device_type
- device_id
- event_id
- format_string

```go
mqttAdaptor.On(fmt.Sprintf("iot-2/type/+/id/%s/evt/+/fmt/json", deviceId), func(data []byte) {
	...
})
```

####Publishing device commands
Your application can publish a command to any registered device. Publish to topic `iot-2/type/device_type/id/device_id/cmd/command_id/fmt/format_string`

```go
cmdData, err := json.Marshal(cmd)
if err == nil {
	mqttAdaptor.Publish(fmt.Sprintf("iot-2/type/gobot-sensor/id/%s/cmd/set_speed/fmt/json", deviceId), cmdData)
} else {
	log.Printf("Error sending command: %s", err)
}
```

For more information about application and device communication see [documentation](https://docs.internetofthings.ibmcloud.com)
